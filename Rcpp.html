<!DOCTYPE html>
<html>
  <head>
    <title>Fast code: R(cpp)</title>
    <meta charset="utf-8">
    <meta name="author" content="Florian Privé &amp; Alexis Arnaud" />
    <meta name="date" content="2018-03-15" />
    <link href="libs/remark-css-0.0.1/example.css" rel="stylesheet" />
    <link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Fast code: R(cpp)
## <a href="https://privefl.github.io/R-presentation/Rcpp.html" class="uri">https://privefl.github.io/R-presentation/Rcpp.html</a>
### Florian Privé &amp; Alexis Arnaud
### March 15, 2018

---






class: center, middle, inverse

# Rcpp

---

## Resources

### Rcpp

- [Advanced R](https://adv-r.hadley.nz/rcpp.html)

- [Rcpp for everyone](https://teuder.github.io/rcpp4everyone_en/)

- [Unofficial Rcpp API Documentation](https://thecoatlessprofessor.com/programming/unofficial-rcpp-api-documentation/)

- [Rcpp Gallery](http://gallery.rcpp.org/)

### RcppArmadillo (linear algebra)

- [RcppArmadillo cheatsheet](https://github.com/petewerner/misc/wiki/RcppArmadillo-cheatsheet)

- [Armadillo documentation](http://arma.sourceforge.net/docs.html)

- [Fix OS X Mavericks "-lgfortran" and "-lquadmath" installation errors](https://thecoatlessprofessor.com/programming/rcpp-rcpparmadillo-and-os-x-mavericks--lgfortran-and--lquadmath-error/)

---

## How I see Rcpp?

&lt;br&gt;

Rcpp lives between R and C++, bringing 

- the *performance of C++* and

- the *convenience of R*.

&lt;br&gt;

As 

- I love *performance* and 

- I also enjoy *simplicity*, 

Rcpp may be my favorite R package.

.footnote[I often speak about Rcpp as if it was a programming language.]

---

## Using Rcpp with RStudio

&lt;img src="http://li-kan.com/image/post/Rcpp/create_file.png" width="80%" style="display: block; margin: auto;" /&gt;

Learn more at https://support.rstudio.com/hc/en-us/articles/200486088-Using-Rcpp-with-RStudio.

---

## First example: testing if number is odd

In R:


```r
is_odd_r &lt;- function(n = 10) {
  n %% 2 == 1
}
```

In Rcpp:


```cpp
// [[Rcpp::export]]
bool is_odd_cpp(int n = 10) {
  bool v = (n % 2 == 1);
  return v;
}
```


```r
c(is_odd_r(),   is_odd_cpp(), 
  is_odd_r(21), is_odd_cpp(21),
  is_odd_r(42), is_odd_cpp(42))
```

```
## [1] FALSE FALSE  TRUE  TRUE FALSE FALSE
```

---

## C++ function explained

### C++ is statically typed

&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="rcpp-graphical.png" alt="Graphical annotation of the &amp;lt;em&amp;gt;is_odd_cpp&amp;lt;/em&amp;gt; function.&amp;lt;br/&amp;gt;&amp;lt;small&amp;gt;https://doi.org/10.7287/peerj.preprints.3188v1&amp;lt;/small&amp;gt;" width="80%" /&gt;
&lt;p class="caption"&gt;Graphical annotation of the &lt;em&gt;is_odd_cpp&lt;/em&gt; function.&lt;br/&gt;&lt;small&gt;https://doi.org/10.7287/peerj.preprints.3188v1&lt;/small&gt;&lt;/p&gt;
&lt;/div&gt;

.footnote[You don't really need `v` here.]

---

## Whole Rcpp file

&lt;img src="rcpp-file.png" width="80%" style="display: block; margin: auto;" /&gt;

.footnote[Source: compile the Rcpp function and execute the block of R code.]

---

## Second example: sum of a vector


```r
sumR &lt;- function(x) {
  total &lt;- 0
  for (i in seq_along(x)) {
    total &lt;- total + x[i]
  }
  total
}
```


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
double sumC1(const NumericVector&amp; x) {
  
  int n = x.size();
  double total = 0;
  for (int i = 0; i &lt; n; i++) {
    total += x[i];
  }
  
  return total;
}
```

---

The C++ version is similar, but:

* To find the length of the vector, we use the `.size()` method (or `.length()`),   which returns an integer. C++ methods are called with `.` (i.e., a full stop).
  
* The `for` statement has a different syntax: `for(init; check; increment)`. 
  This loop is initialised by creating a new variable called `i` with value 0.
  Before each iteration we check that `i &lt; n`, and terminate the loop if it's 
  not. After each iteration, we increment the value of `i` by one, using the
  special prefix operator `++` which increases the value of `i` by 1.

* In C++, vector indices start at 0. I'll say this again because it's so 
  important: __IN C++, VECTOR INDICES START AT 0__! This is a very common 
  source of bugs when converting R functions to C++.

* Use `=` for assignment, not `&lt;-`.

* C++ provides operators that modify in-place: `total += x[i]` is equivalent to 
  `total = total + x[i]`. Similar in-place operators are `-=`, `*=`, and `/=`.

---

## Rcpp Sugar

With [Rcpp Sugar](http://dirk.eddelbuettel.com/code/rcpp/Rcpp-sugar.pdf), you have accessed to some R-like vectorized functions:


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
double sumCS(const NumericVector&amp; x) {
  return sum(x);
}
```

There are many [R functions available in Rcpp](https://thecoatlessprofessor.com/programming/unofficial-rcpp-api-documentation/#sugar).

---

## Yet other possibilities


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
double sumC2(const NumericVector&amp; x) {
  
  double total = 0;
  NumericVector::const_iterator it;
  for (it = x.begin(); it != x.end(); it++) {
    total += *it;
  }
  return total;
}

// [[Rcpp::export]]
double sumC3(const NumericVector&amp; x) {
  return std::accumulate(x.begin(), x.end(), 0.0);
}
```

---

## Microbenchmark


```r
x &lt;- runif(1e5)

microbenchmark::microbenchmark(
  "R LOOP" = sumR(x),
  "R VEC"  = sum(x),
  "C LOOP" = sumC1(x),
  "C VEC"  = sumCS(x),
  "C IT"   = sumC2(x),
  "C STD"  = sumC3(x)
)
```

```
## Unit: microseconds
##    expr      min       lq       mean    median        uq      max neval cld
##  R LOOP 3928.685 4191.899 4422.94922 4342.5440 4568.5115 6825.039   100   c
##   R VEC   77.805   79.461   86.54304   83.5995   85.7520  164.882   100 a  
##  C LOOP   79.792   80.620   95.39975   83.9310   89.2285  677.736   100 a  
##   C VEC   80.123   80.455   94.31362   85.0900   92.7040  652.905   100 a  
##    C IT  264.870  265.698  294.18796  267.1880  287.5500  989.290   100  b 
##   C STD   78.468   80.455   97.32990   81.7790   85.9175 1145.894   100 a
```

---

## Which R functions does this implement? (1/5)


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
double f1(NumericVector x) {
  
  int n = x.size();
  double y = 0;

  for (int i = 0; i &lt; n; i++) {
    y += x[i];
  }
  
  return y / n;
}
```

---

## Which R functions does this implement? (2/5)


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector f2(NumericVector x) {
  
  int n = x.size();
  NumericVector out(n);

  out[0] = x[0];
  for (int i = 1; i &lt; n; i++) {
    out[i] = out[i - 1] + x[i];
  }
  
  return out;
}
```

---

## Which R functions does this implement? (3/5)


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
bool f3(LogicalVector x) {
  
  int n = x.size();

  for (int i = 0; i &lt; n; i++) {
    if (x[i]) return true;
  }
  
  return false;
}
```

---

## Which R functions does this implement? (4/5)


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector f4(List x) {
  
  int n = x.size();
  NumericVector res(n);

  for (int i = 0; i &lt; n; i++) {
    res[i] = mean( as&lt;NumericVector&gt;(x[i]) );
  }
  
  return res;
}
```

---

## Which R functions does this implement? (5/5)


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector f5(NumericVector x, NumericVector y) {
  
  // Recycling
  int n = std::max(x.size(), y.size());
  NumericVector x1 = rep_len(x, n);
  NumericVector y1 = rep_len(y, n);

  NumericVector out(n);

  for (int i = 0; i &lt; n; i++) {
    out[i] = std::min(x1[i], y1[i]);
  }

  return out;
}
```

---

## Which R functions does this implement? Answers


```r
x &lt;- runif(100)
stopifnot(isTRUE(all.equal(f1(x), mean(x))))
```


```r
stopifnot(isTRUE(all.equal(f2(x), cumsum(x))))
```


```r
x2 &lt;- rep(FALSE, 10)
stopifnot(isTRUE(all.equal(f3(x2), any(x2))))
x2[1] &lt;- TRUE
stopifnot(isTRUE(all.equal(f3(x2), any(x2))))
x2[] &lt;- TRUE
stopifnot(isTRUE(all.equal(f3(x2), any(x2))))
```


```r
x3 &lt;- lapply(1:10, runif)
stopifnot(isTRUE(all.equal(f4(x3), sapply(x3, mean))))
```


```r
x4 &lt;- runif(11)
stopifnot(isTRUE(all.equal(f5(x, x4), pmin(x, x4))))
```

```
## Warning in pmin(x, x4): an argument will be fractionally recycled
```

---

## Use of C++ code when needed

More infos [there](http://adv-r.had.co.nz/Rcpp.html).

Typical bottlenecks that C++ can address include:

- Recursive functions, or problems which involve calling functions **millions of times**. 
The overhead of calling a function in C++ is much lower than that in R.

- Loops that **can’t be easily vectorised** because subsequent iterations depend on previous ones.

- Problems that require **advanced data structures** and algorithms that R doesn’t provide. Through the standard template library (STL), C++ has efficient implementations of many important data structures, from ordered maps to double-ended queues.

---

## Third example: Gibbs sampler


```r
gibbs_r &lt;- function(N, thin) {
  
  mat &lt;- matrix(nrow = 2, ncol = N)
  x &lt;- y &lt;- 0

  for (i in 1:N) {
    for (j in 1:thin) {
      x &lt;- rgamma(1, 3, y * y + 4)
      y &lt;- rnorm(1, 1 / (x + 1), 1 / sqrt(2 * (x + 1)))
    }
    mat[, i] &lt;- c(x, y)
  }
  
  mat
}
```

&lt;br&gt;

This function is difficult to vectorize because iterations depend on previous ones.

---

### Recode it in Rcpp


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
NumericMatrix gibbs_cpp(int N, int thin) {
  
  NumericMatrix mat(2, N);
  double x = 0, y = 0;

  for(int i = 0; i &lt; N; i++) {
    for(int j = 0; j &lt; thin; j++) {
      x = rgamma(1, 3, 1 / (y * y + 4))[0];
      y = rnorm(1, 1 / (x + 1), 1 / sqrt(2 * (x + 1)))[0];
    }
    mat(0, i) = x;
    mat(1, i) = y;
  }

  return(mat);
}
```

There is not much difference with the previous R version!

---

### Microbenchmark


```r
microbenchmark::microbenchmark(
  gibbs_r(100, 10),
  gibbs_cpp(100, 10),
  gibbs_r(1000, 10),
  gibbs_cpp(1000, 10)
)
```

```
## Unit: microseconds
##                 expr       min         lq       mean    median        uq
##     gibbs_r(100, 10)  3056.931  3221.6480  4050.2671  3521.117  5109.509
##   gibbs_cpp(100, 10)   209.579   238.7145   254.4277   246.164   263.215
##    gibbs_r(1000, 10) 36485.850 38314.6125 42180.2316 38819.189 39407.697
##  gibbs_cpp(1000, 10)  2259.011  2343.4385  2574.3616  2440.778  2615.757
##         max neval cld
##   15529.332   100  b 
##     402.271   100 a  
##  147122.402   100   c
##    4932.874   100 ab
```

---

## Other Rcpp code examples

&lt;a href="https://github.com/hadley/adv-r/blob/master/extras/cpp" target="_blank"&gt;
&lt;img src="Rcpp_files/figure-html/unnamed-chunk-25-1.png" width="80%" style="display: block; margin: auto;" /&gt;
&lt;/a&gt;

---

## Two traps in one


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
void copy_vec(NumericVector x) {
  NumericVector y = x;
  y[0] = 100;
}
```


```r
x2 &lt;- runif(10)
copy_vec(x2)
x2
```

```
##  [1] 1.000000e+02 2.800139e-01 7.037642e-01 8.331847e-02 4.322862e-01
##  [6] 5.122568e-03 6.033713e-01 2.419494e-02 5.343699e-01 7.640610e-01
```

```r
x1 &lt;- 1:10
copy_vec(x1)
x1
```

```
##  [1]  1  2  3  4  5  6  7  8  9 10
```

---

## Two traps in one, explanation

- R objects are always passed by reference in Rcpp (even without the `&amp;`). Use `clone()` to get a copy.

- But if e.g. passing a vector of type integer (`1:10`) as a NumericVector (type double), the vector will be copied (and casted to type double).


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
void copy_vec2(NumericVector x) {
  NumericVector y = clone(x);
  y[0] = 100;
}
```


```r
x2 &lt;- runif(10)
copy_vec2(x2)
x2
```

```
##  [1] 0.3264166 0.1571657 0.8829253 0.8761071 0.9989693 0.5420591 0.4623538
##  [8] 0.6239972 0.2195481 0.4516819
```

---

## Yet another trap (of C++)


```cpp
#include &lt;Rcpp.h&gt;
using namespace Rcpp;

// [[Rcpp::export]]
double int_div() {
  int x = 2, y = 3;
  double z = x / y;
  return z;
}

// [[Rcpp::export]]
double int_div2() {
  int x = 2, y = 3;
  return (double)x / y;
}
```


```r
c(int_div(), int_div2())
```

```
## [1] 0.0000000 0.6666667
```


---

class: center, middle, inverse

# Thanks!

&lt;br&gt;

Presentation available at

https://privefl.github.io/R-presentation/Rcpp.html

&lt;br&gt;

<i class="fa  fa-twitter "></i> [privefl](https://twitter.com/privefl) &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; <i class="fa  fa-github "></i> [privefl](https://github.com/privefl) &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; <i class="fa  fa-stack-overflow "></i> [F. Privé](https://stackoverflow.com/users/6103040/f-priv%c3%a9)

.footnote[Slides created via R package [**xaringan**](https://github.com/yihui/xaringan).]
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {window.dispatchEvent(new Event('resize'));});
(function() {var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler"); if (!r) return; s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }"; d.head.appendChild(s);})();</script>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
